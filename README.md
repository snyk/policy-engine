# Unified Policy Engine

## Building & running

    go build
    ./unified-policy-engine

## Rule Syntax Tutorial

We will walk through the rules in the examples directory, starting out with
simple rules and gradually adding concepts.

### Simple rules part 1

[examples/01-simple.rego](examples/01-simple.rego)

### Simple rules part 2: Returning attributes

[examples/02-simple-attributes.rego](examples/02-simple-attributes.rego)

### Advanced rules part 1

[examples/02-advanced.rego](examples/03-advanced.rego)

### Advanced rules part 2: Adding compliant resource info

[examples/03-advanced.rego](examples/04-advanced.rego)

### Advanced rules part 3: Correlating resources

[examples/04-advanced.rego](examples/05-advanced.rego)

### Advanced rules part 4: Returning attributes

[examples/06-advanced.rego](examples/06-advanced.rego)

### Missing resources

[examples/07-missing.rego](examples/07-missing.rego)

## Reference

### Info objects

Info objects have different fields depending in which context they occur.

`deny[info]` fields:

 -  `message`: Message string detailing the issue.  **Required.**
 -  `resource`: Resource associated with the issue.
 -  `attributes`: List of [attribute paths](#attribute-paths).
 -  `resource_type`: May be used to indicate the resource type in case of a
    missing resource.
 -  `correlation`: May be used to override the correlation the policy engine
    uses to relate issues.  Defaults to `.resource.id`.

`resources[info]` fields:

 -  `resource`: Resource associated with the issue.  **Required.**
 -  `attributes`: List of [attribute paths](#attribute-paths).
 -  `correlation`: May be used to override the correlation the policy engine
    uses to relate issues.  Defaults to `.resource.id`.

#### Attribute paths

Attribute paths are JSON arrays of strings and numbers.  They items in these
arrays correspond to indices in objects and arrays respectively.

Considering the following JSON attributes:

```json
{
  "ingress": [
    {
      "from_port": 22,
      "to_port": 22
    }
  ]
}
```

Then the `from_port` path would be `["ingress", 0, "from_port"]`.

### snyk API

 -  `snyk.resources(resource_type)`:
    Returns a object of resource IDs to resources of the requested type.

## Testing rules

In order to test rules, we want to generate _fixtures_ so that we freeze in
the processed input generated by the Unified Policy Engine.  This allows us
to use standard OPA tooling.

You can generate a fixture using the `fixture` command.  For example, we can
generate a fixture for the example terraform file we are using like this:

    ./unified-policy-engine fixture examples/main.tf >examples/tests/fixture.json

Fixtures can also be generated using other applications.  The important bit is
that a fixture should provide a `mock_input` rule which represents the input to
be used for the test.

This allows us to import and use the fixture in a test:

[examples/tests/advanced-rule-test.rego](examples/tests/advanced-rule-test.rego)

Running the tests:

    ./unified-policy-engine -d examples test

We can also run using vanilla OPA.  This requires us to pass in the
[rego/](rego/) directory as well:

    opa test examples rego
